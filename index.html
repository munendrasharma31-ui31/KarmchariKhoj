<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>Employee Verification</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-6 rounded-2xl shadow max-w-md w-full">

<h1 class="text-xl font-bold mb-4 text-center">Employee Verification</h1>

<!-- DISTRICT -->
<select id="district" class="border p-2 rounded w-full mb-3">
<option value="">Select District</option>
<option value="Agra">Agra</option>
<option value="Aligarh">Aligarh</option>
<option value="Ambedkar Nagar">Ambedkar Nagar</option>
<option value="Amethi">Amethi</option>
<option value="Amroha">Amroha</option>
<option value="Auraiya">Auraiya</option>
<option value="Ayodhya">Ayodhya</option>
<option value="Azamgarh">Azamgarh</option>
<option value="Baghpat">Baghpat</option>
<option value="Bahraich">Bahraich</option>
<option value="Ballia">Ballia</option>
<option value="Balrampur">Balrampur</option>
<option value="Banda">Banda</option>
<option value="Barabanki">Barabanki</option>
<option value="Bareilly">Bareilly</option>
<option value="Basti">Basti</option>
<option value="Bhadohi">Bhadohi</option>
<option value="Bijnor">Bijnor</option>
<option value="Budaun">Budaun</option>
<option value="Bulandshahr">Bulandshahr</option>
<option value="Chandauli">Chandauli</option>
<option value="Chitrakoot">Chitrakoot</option>
<option value="Deoria">Deoria</option>
<option value="Etah">Etah</option>
<option value="Etawah">Etawah</option>
<option value="Farrukhabad">Farrukhabad</option>
<option value="Fatehpur">Fatehpur</option>
<option value="Firozabad">Firozabad</option>
<option value="Gautam Buddha Nagar">Gautam Buddha Nagar</option>
<option value="Ghaziabad">Ghaziabad</option>
<option value="Ghazipur">Ghazipur</option>
<option value="Gonda">Gonda</option>
<option value="Gorakhpur">Gorakhpur</option>
<option value="Hamirpur">Hamirpur</option>
<option value="Hapur">Hapur</option>
<option value="Hardoi">Hardoi</option>
<option value="Hathras">Hathras</option>
<option value="Jalaun">Jalaun</option>
<option value="Jaunpur">Jaunpur</option>
<option value="Jhansi">Jhansi</option>
<option value="Kannauj">Kannauj</option>
<option value="Kanpur Dehat">Kanpur Dehat</option>
<option value="Kanpur Nagar">Kanpur Nagar</option>
<option value="Kasganj">Kasganj</option>
<option value="Kaushambi">Kaushambi</option>
<option value="Kushinagar">Kushinagar</option>
<option value="Lakhimpur Kheri">Lakhimpur Kheri</option>
<option value="Lalitpur">Lalitpur</option>
<option value="Lucknow">Lucknow</option>
<option value="Maharajganj">Maharajganj</option>
<option value="Mahoba">Mahoba</option>
<option value="Mainpuri">Mainpuri</option>
<option value="Mathura">Mathura</option>
<option value="Mau">Mau</option>
<option value="Meerut">Meerut</option>
<option value="Mirzapur">Mirzapur</option>
<option value="Moradabad">Moradabad</option>
</select>

<!-- OFFICE -->
<select id="office" class="border p-2 rounded w-full mb-3">
<option value="">Select Office</option>
</select>

<!-- EMPLOYEE -->
<select id="employee" class="border p-2 rounded w-full mb-3">
<option value="">Select Employee</option>
</select>

<!-- PHONE INFO -->
<div id="phoneBox" class="hidden text-sm mb-3 text-gray-600"></div>

<!-- reCAPTCHA -->
<div id="recaptcha-container"></div>

<!-- SEND OTP -->
<button id="sendOtp"
 class="bg-indigo-600 text-white w-full p-3 rounded-xl font-bold hidden">
Send OTP
</button>

<!-- OTP INPUT -->
<input id="otp" placeholder="Enter OTP"
 class="border p-2 rounded w-full mt-4 hidden">

<!-- VERIFY OTP -->
<button id="verifyOtp"
 class="bg-green-600 text-white w-full p-3 rounded-xl font-bold mt-3 hidden">
Verify OTP
</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  RecaptchaVerifier,
  signInWithPhoneNumber
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBDE0Oy6bSo05jl48kugFnrtHAPZt-eanA",
  authDomain: "antrik-lekha.firebaseapp.com",
  projectId: "antrik-lekha",
  appId: "1:82198306544:web:bfb58e6c8d03f7d664ac35"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ELEMENTS */
const district = document.getElementById("district");
const office = document.getElementById("office");
const employee = document.getElementById("employee");
const phoneBox = document.getElementById("phoneBox");
const sendOtp = document.getElementById("sendOtp");
const otpInput = document.getElementById("otp");
const verifyOtp = document.getElementById("verifyOtp");

let selectedPhone = "";
let confirmationResult;
let recaptchaVerifier;

/* ðŸ” INIT reCAPTCHA AFTER PAGE LOAD */
window.onload = () => {
  recaptchaVerifier = new RecaptchaVerifier(
    auth,
    'recaptcha-container',
    { size: 'invisible' }
  );
};

/* LOAD OFFICES BASED ON DISTRICT */
district.onchange = async () => {
  office.innerHTML = `<option value="">Select Office</option>`;
  employee.innerHTML = `<option value="">Select Employee</option>`;
  phoneBox.classList.add("hidden");
  sendOtp.classList.add("hidden");

  if (!district.value) return;

  const q = query(
    collection(db, "employees"),
    where("district", "==", district.value)
  );

  const snap = await getDocs(q);
  const offices = [...new Set(snap.docs.map(d => d.data().office))];

  offices.forEach(o => {
    if (!o) return;
    const opt = document.createElement("option");
    opt.textContent = o;
    office.appendChild(opt);
  });
};

/* LOAD EMPLOYEES */
office.onchange = async () => {
  employee.innerHTML = `<option value="">Select Employee</option>`;
  phoneBox.classList.add("hidden");
  sendOtp.classList.add("hidden");

  if (!office.value) return;

  const q = query(
    collection(db, "employees"),
    where("district", "==", district.value),
    where("office", "==", office.value)
  );

  const snap = await getDocs(q);
  snap.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d.data().phone;
    opt.textContent = d.data().name;
    employee.appendChild(opt);
  });
};

/* EMPLOYEE SELECT */
employee.onchange = () => {
  selectedPhone = employee.value;

  if (!selectedPhone) return;

  selectedPhone = selectedPhone.replace(/\D/g, "");
  const masked = "+91 XXXXX" + selectedPhone.slice(-4);

  phoneBox.textContent = `OTP will be sent to ${masked}`;
  phoneBox.classList.remove("hidden");
  sendOtp.classList.remove("hidden");
};

/* SEND OTP */
sendOtp.onclick = async () => {
  try {
    if (selectedPhone.length !== 10) {
      alert("Invalid mobile number");
      return;
    }

    confirmationResult = await signInWithPhoneNumber(
      auth,
      "+91" + selectedPhone,
      recaptchaVerifier
    );

    otpInput.classList.remove("hidden");
    verifyOtp.classList.remove("hidden");
    alert("OTP sent successfully");

  } catch (err) {
    console.error("OTP ERROR:", err);
    alert(err.message);
  }
};

/* VERIFY OTP */
verifyOtp.onclick = async () => {
  try {
    await confirmationResult.confirm(otpInput.value);
    window.location.href = "public-dashboard.html";
  } catch (err) {
    alert("Invalid OTP");
  }
};
</script>

</body>
</html>
