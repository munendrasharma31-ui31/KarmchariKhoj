<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>UPIAAD | Employee Login</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-6 rounded-2xl shadow max-w-md w-full">

<!-- LOGO -->
<div class="flex flex-col items-center mb-6">
  <img src="up.png" class="h-40 w-auto object-contain">
  <p class="text-xl font-bold mt-2 text-center">
    ‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§≤‡•á‡§ñ‡§æ ‡§è‡§µ‡§Ç ‡§≤‡•á‡§ñ‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§¶‡•á‡§∂‡§æ‡§≤‡§Ø
  </p>
  <p class="text-sm text-slate-500">UPIAAD Employee Portal</p>
</div>

<p class="text-sm text-center text-slate-600 mb-4">
  ‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡•ç‡§∞‡§Æ ‡§∏‡•á ‡§ú‡§ø‡§≤‡§æ, ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§è‡§µ‡§Ç ‡§®‡§æ‡§Æ ‡§ö‡•Å‡§®‡•á‡§Ç
</p>

<!-- DISTRICT (SORTED) -->
<select id="district" class="border p-2 rounded w-full mb-3">
  <option value="">Select District</option>
</select>

<!-- OFFICE -->
<select id="office" disabled
  class="border p-2 rounded w-full mb-3 bg-slate-100 cursor-not-allowed">
  <option>Select Office</option>
</select>

<!-- EMPLOYEE -->
<select id="employee" disabled
  class="border p-2 rounded w-full mb-3 bg-slate-100 cursor-not-allowed">
  <option>Select Employee</option>
</select>

<!-- PASSWORD WITH TOGGLE -->
<div class="relative mb-3">
  <input id="password" type="password" disabled
    placeholder="Enter Password"
    class="border p-2 rounded w-full pr-10 bg-slate-100 cursor-not-allowed">
  <button type="button" id="togglePwd"
    class="absolute right-3 top-2.5 text-slate-500">üëÅ</button>
</div>

<div class="flex gap-2">
  <button id="loginBtn" disabled
    class="bg-indigo-600 opacity-50 text-white w-full p-3 rounded-xl font-bold cursor-not-allowed">
    Login
  </button>
  <button id="resetBtn"
    class="bg-slate-200 px-4 rounded-xl font-semibold">
    Reset
  </button>
</div>

<p id="msg" class="text-red-600 text-sm mt-3"></p>

<div class="mt-6 text-center border-t pt-4">
  <a href="admin-login.html" class="text-indigo-600 font-bold">
    üîê Admin Login
  </a>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, where }
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBDE0Oy6bSo05jl48kugFnrtHAPZt-eanA",
  authDomain: "antrik-lekha.firebaseapp.com",
  projectId: "antrik-lekha",
  appId: "1:82198306544:web:bfb58e6c8d03f7d664ac35"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const district = document.getElementById("district");
const office = document.getElementById("office");
const employee = document.getElementById("employee");
const password = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");
const resetBtn = document.getElementById("resetBtn");
const togglePwd = document.getElementById("togglePwd");
const msg = document.getElementById("msg");

let selectedEmployee = null;

function enable(el){
  el.disabled=false;
  el.classList.remove("bg-slate-100","cursor-not-allowed","opacity-50");
}
function disable(el){
  el.disabled=true;
  el.classList.add("bg-slate-100","cursor-not-allowed","opacity-50");
}

/* SHOW / HIDE PASSWORD */
togglePwd.onclick = () => {
  password.type = password.type === "password" ? "text" : "password";
};

/* RESET */
resetBtn.onclick = () => {
  district.value="";
  office.innerHTML="<option>Select Office</option>";
  employee.innerHTML="<option>Select Employee</option>";
  password.value="";
  msg.textContent="";
  disable(office); disable(employee); disable(password); disable(loginBtn);
};

/* LOAD DISTRICTS (SORTED FROM FIRESTORE) */
(async()=>{
  const snap = await getDocs(collection(db,"employees"));
  const districts = [...new Set(
    snap.docs.map(d=>d.data().district)
  )].sort((a,b)=>a.localeCompare(b));

  districts.forEach(d=>{
    district.innerHTML+=`<option>${d}</option>`;
  });
})();

/* DISTRICT ‚Üí OFFICE (SORTED) */
district.onchange = async () => {
  msg.textContent="";
  enable(office); disable(employee); disable(password); disable(loginBtn);
  office.innerHTML="<option>Loading...</option>";

  const q = query(collection(db,"employees"),
    where("district","==",district.value));
  const snap = await getDocs(q);

  const offices=[...new Set(
    snap.docs.map(d=>d.data().office)
  )].sort((a,b)=>a.localeCompare(b));

  office.innerHTML="<option value=''>Select Office</option>";
  offices.forEach(o=>office.innerHTML+=`<option>${o}</option>`);
};

/* OFFICE ‚Üí EMPLOYEE (SORTED) */
office.onchange = async () => {
  enable(employee); disable(password); disable(loginBtn);
  employee.innerHTML="<option>Loading...</option>";

  const q=query(collection(db,"employees"),
    where("district","==",district.value),
    where("office","==",office.value));
  const snap=await getDocs(q);

  const emps=snap.docs
    .map(d=>({id:d.id,name:d.data().name,phone:d.data().phone}))
    .sort((a,b)=>a.name.localeCompare(b.name));

  employee.innerHTML="<option value=''>Select Employee</option>";
  emps.forEach(e=>{
    employee.innerHTML+=`<option value="${e.id}">${e.name}</option>`;
  });
};

employee.onchange=()=>enable(password);
password.oninput=()=>enable(loginBtn);

/* LOGIN */
loginBtn.onclick=async()=>{
  const snap=await getDocs(collection(db,"employees"));
  snap.forEach(d=>{
    if(d.id===employee.value) selectedEmployee=d.data();
  });

  const first=selectedEmployee.name.split(" ")[0];
  const last5=selectedEmployee.phone.slice(-5);

  if(password.value.toLowerCase()===(first+last5).toLowerCase()){
    sessionStorage.setItem("empAuth","true");
    sessionStorage.setItem("empName",selectedEmployee.name);
    location.href="public-dashboard.html";
  } else {
    msg.textContent="Invalid password";
  }
};
</script>
</body>
</html>
