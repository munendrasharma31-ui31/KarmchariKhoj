<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Employee Verification</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { font-family: 'Plus Jakarta Sans', sans-serif; }
</style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

<div class="bg-white p-6 rounded-2xl shadow max-w-md w-full">

<h1 class="text-xl font-bold mb-4 text-center">Employee Verification</h1>

<!-- District Dropdown -->
<select id="district" class="border p-2 rounded w-full mb-3">
  <option value="">Select District</option>
  <option value="Lucknow">लखनऊ (Lucknow)</option>
  <option value="Kanpur Nagar">कानपुर नगर (Kanpur Nagar)</option>
  <option value="Varanasi">वाराणसी (Varanasi)</option>
  <option value="Agra">आगरा (Agra)</option>
</select>

<!-- Office Dropdown -->
<select id="office" class="border p-2 rounded w-full mb-3">
  <option value="">Select Office</option>
</select>

<!-- Employee Dropdown -->
<select id="employee" class="border p-2 rounded w-full mb-3">
  <option value="">Select Employee</option>
</select>

<!-- Phone Info -->
<div id="phoneBox" class="hidden text-sm mb-3 text-gray-600"></div>

<!-- reCAPTCHA -->
<div id="recaptcha-container"></div>

<!-- Send OTP -->
<button id="sendOtp" class="bg-indigo-600 text-white w-full p-3 rounded-xl font-bold hidden">
Send OTP
</button>

<!-- OTP Input -->
<input id="otp" placeholder="Enter OTP" class="border p-2 rounded w-full mt-4 hidden">

<!-- Verify OTP -->
<button id="verifyOtp" class="bg-green-600 text-white w-full p-3 rounded-xl font-bold mt-3 hidden">
Verify OTP
</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBDE0Oy6bSo05jl48kugFnrtHAPZt-eanA",
  authDomain: "antrik-lekha.firebaseapp.com",
  projectId: "antrik-lekha",
  appId: "1:82198306544:web:bfb58e6c8d03f7d664ac35"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* Elements */
const district = document.getElementById("district");
const office = document.getElementById("office");
const employee = document.getElementById("employee");
const phoneBox = document.getElementById("phoneBox");
const sendOtp = document.getElementById("sendOtp");
const otpInput = document.getElementById("otp");
const verifyOtp = document.getElementById("verifyOtp");

let selectedPhone = "";
let confirmationResult;
let recaptchaVerifier;

/* Init reCAPTCHA */
window.onload = () => {
  recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
};

/* Load Offices based on District */
district.onchange = async () => {
  office.innerHTML = `<option value="">Select Office</option>`;
  employee.innerHTML = `<option value="">Select Employee</option>`;
  phoneBox.classList.add("hidden");
  sendOtp.classList.add("hidden");

  if (!district.value) return;

  try {
    const q = query(collection(db, "employees"), where("district", "==", district.value));
    const snap = await getDocs(q);

    const offices = [...new Set(
      snap.docs.map(d => d.data().office).filter(o => o && o.trim() !== "")
    )];

    offices.forEach(o => {
      const opt = document.createElement("option");
      opt.value = o;
      opt.textContent = o;
      office.appendChild(opt);
    });

  } catch (err) {
    console.error("Error fetching offices:", err);
    alert("Failed to load offices. Check console.");
  }
};

/* Load Employees based on Office */
office.onchange = async () => {
  employee.innerHTML = `<option value="">Select Employee</option>`;
  phoneBox.classList.add("hidden");
  sendOtp.classList.add("hidden");

  if (!office.value) return;

  try {
    const q = query(
      collection(db, "employees"),
      where("district", "==", district.value),
      where("office", "==", office.value)
    );

    const snap = await getDocs(q);

    snap.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.data().phone;
      opt.textContent = d.data().name;
      employee.appendChild(opt);
    });

  } catch (err) {
    console.error("Error fetching employees:", err);
  }
};

/* Employee selection */
employee.onchange = () => {
  selectedPhone = employee.value;

  if (!selectedPhone) return;

  selectedPhone = selectedPhone.replace(/\D/g, "");
  const masked = "+91 XXXXX" + selectedPhone.slice(-4);

  phoneBox.textContent = `OTP will be sent to ${masked}`;
  phoneBox.classList.remove("hidden");
  sendOtp.classList.remove("hidden");
};

/* Send OTP */
sendOtp.onclick = async () => {
  try {
    if (selectedPhone.length !== 10) {
      alert("Invalid mobile number");
      return;
    }

    confirmationResult = await signInWithPhoneNumber(auth, "+91" + selectedPhone, recaptchaVerifier);

    otpInput.classList.remove("hidden");
    verifyOtp.classList.remove("hidden");
    alert("OTP sent successfully");

  } catch (err) {
    console.error("OTP ERROR:", err);
    alert(err.message);
  }
};

/* Verify OTP */
verifyOtp.onclick = async () => {
  try {
    await confirmationResult.confirm(otpInput.value);
    window.location.href = "public-dashboard.html";
  } catch (err) {
    alert("Invalid OTP");
  }
};
</script>

</body>
</html>
