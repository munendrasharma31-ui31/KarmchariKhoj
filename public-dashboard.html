<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<title>‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§≤‡•á‡§ñ‡§æ ‡§è‡§µ‡§Ç ‡§≤‡•á‡§ñ‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§¶‡•á‡§∂‡§æ‡§≤‡§Ø | Public Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></script>
</head>

<body class="bg-slate-100">

<!-- üîê SESSION CHECK -->
<script>
if (sessionStorage.getItem("empAuth") !== "true") {
  location.href = "index.html";
}
</script>

<!-- HEADER -->
<header class="bg-indigo-700 text-white py-4">
  <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold">‡§Ü‡§®‡•ç‡§§‡§∞‡§ø‡§ï ‡§≤‡•á‡§ñ‡§æ ‡§è‡§µ‡§Ç ‡§≤‡•á‡§ñ‡§æ ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§¶‡•á‡§∂‡§æ‡§≤‡§Ø</h1>
      <p class="text-sm opacity-90">Employee Dashboard</p>
    </div>

    <div class="flex items-center gap-4">
      <span class="text-sm">
        üë§ <b id="userName"></b>
      </span>
      <button onclick="logout()"
        class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-xl font-bold">
        Logout
      </button>
    </div>
  </div>
</header>

<!-- MAIN -->
<main class="max-w-5xl mx-auto p-6">

<!-- FILTERS -->
<div class="bg-white p-6 rounded-2xl shadow mb-8 grid md:grid-cols-6 gap-4">

  <!-- DISTRICT -->
  <select id="district" class="border p-2 rounded w-full">
    <option value="">Select District</option>
    <!-- district list unchanged -->
    <option value="Agra">Agra</option>
    <option value="Aligarh">Aligarh</option>
    <option value="Lucknow">Lucknow</option>
    <option value="Prayagraj">Prayagraj</option>
    <option value="Varanasi">Varanasi</option>
    <!-- ‡§¨‡§æ‡§ï‡•Ä ‡§µ‡§π‡•Ä -->
  </select>

  <!-- OFFICE -->
  <select id="officeSelect" class="border p-3 rounded-xl">
    <option value="">Select Office</option>
  </select>

  <!-- POST -->
  <select id="postSelect" class="border p-3 rounded-xl">
    <option value="">Select Post</option>
    <option value="Assistant Accountant">Assistant Accountant</option>
    <option value="Accountant">Accountant</option>
    <option value="Assistant Account Officer">Assistant Account Officer</option>
  </select>

  <!-- EMPLOYEE DROPDOWN -->
  <select id="employeeSelect" class="border p-3 rounded-xl">
    <option value="">Select Employee</option>
  </select>

  <!-- üÜï SEARCH BY NAME -->
  <input id="nameSearch"
    type="text"
    placeholder="Type employee name"
    class="border p-3 rounded-xl"/>

  <!-- SEARCH BUTTON -->
  <button id="searchBtn"
    class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-xl">
    Search
  </button>
</div>

<!-- RESULT -->
<div id="resultArea" class="hidden">
  <div class="bg-white p-6 rounded-2xl shadow">
    <h3 id="empName" class="text-xl font-bold text-indigo-700"></h3>
    <p class="mt-2"><b>üìû Mobile:</b> <span id="empPhone"></span></p>
    <p><b>üìç District:</b> <span id="empDistrict"></span></p>
    <p><b>üè¢ Office:</b> <span id="empOffice"></span></p>
    <p><b>üëî Post:</b> <span id="empPost"></span></p>
  </div>
</div>

<div id="noResult" class="hidden text-center text-slate-500 mt-12">
  <i class="fa-solid fa-user-slash text-4xl mb-3"></i>
  <p class="font-semibold">No record found</p>
</div>

</main>

<!-- FIREBASE LOGIC -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyBDE0Oy6bSo05jl48kugFnrtHAPZt-eanA",
  authDomain: "antrik-lekha.firebaseapp.com",
  projectId: "antrik-lekha",
  appId: "1:82198306544:web:bfb58e6c8d03f7d664ac35"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ELEMENTS */
const districtSelect = document.getElementById("district");
const officeSelect = document.getElementById("officeSelect");
const postSelect = document.getElementById("postSelect");
const employeeSelect = document.getElementById("employeeSelect");
const nameSearch = document.getElementById("nameSearch");
const searchBtn = document.getElementById("searchBtn");

const resultArea = document.getElementById("resultArea");
const noResult = document.getElementById("noResult");

const empName = document.getElementById("empName");
const empPhone = document.getElementById("empPhone");
const empDistrict = document.getElementById("empDistrict");
const empOffice = document.getElementById("empOffice");
const empPost = document.getElementById("empPost");

let cachedEmployees = [];

/* USER NAME */
document.getElementById("userName").innerText =
  sessionStorage.getItem("empName") || "";

/* DISTRICT ‚Üí OFFICE */
districtSelect.onchange = async () => {
  officeSelect.innerHTML = `<option value="">Select Office</option>`;
  employeeSelect.innerHTML = `<option value="">Select Employee</option>`;
  nameSearch.value = "";
  resultArea.classList.add("hidden");

  if (!districtSelect.value) return;

  const q = query(collection(db, "employees"),
    where("district", "==", districtSelect.value));
  const snap = await getDocs(q);

  const offices = [...new Set(
    snap.docs.map(d => d.data().office).filter(Boolean)
  )].sort((a,b)=>a.localeCompare(b));

  offices.forEach(o=>{
    officeSelect.innerHTML += `<option>${o}</option>`;
  });
};

/* OFFICE / POST ‚Üí LOAD EMPLOYEES */
async function loadEmployees(){
  employeeSelect.innerHTML = `<option value="">Select Employee</option>`;
  cachedEmployees = [];
  nameSearch.value = "";

  if(!districtSelect.value || !officeSelect.value) return;

  const q = query(collection(db,"employees"),
    where("district","==",districtSelect.value),
    where("office","==",officeSelect.value));
  const snap = await getDocs(q);

  snap.forEach(d=>{
    const e = { id:d.id, ...d.data() };
    if(postSelect.value && e.post !== postSelect.value) return;
    cachedEmployees.push(e);
    employeeSelect.innerHTML += `<option value="${e.id}">${e.name}</option>`;
  });
}

officeSelect.onchange = loadEmployees;
postSelect.onchange = loadEmployees;

/* üÜï SEARCH BY NAME (TYPING) */
nameSearch.oninput = () => {
  const txt = nameSearch.value.toLowerCase();
  employeeSelect.innerHTML = `<option value="">Select Employee</option>`;

  cachedEmployees
    .filter(e => e.name.toLowerCase().includes(txt))
    .forEach(e=>{
      employeeSelect.innerHTML +=
        `<option value="${e.id}">${e.name}</option>`;
    });
};

/* SEARCH BUTTON */
searchBtn.onclick = async () => {
  resultArea.classList.add("hidden");
  noResult.classList.add("hidden");

  if (!employeeSelect.value) {
    alert("Please select employee");
    return;
  }

  const snap = await getDoc(doc(db,"employees",employeeSelect.value));
  if (!snap.exists()) {
    noResult.classList.remove("hidden");
    return;
  }

  const e = snap.data();
  empName.innerText = e.name;
  empPhone.innerText = e.phone;
  empDistrict.innerText = e.district;
  empOffice.innerText = e.office;
  empPost.innerText = e.post;

  resultArea.classList.remove("hidden");
};

/* LOGOUT */
window.logout = () => {
  sessionStorage.clear();
  location.href = "index.html";
};
</script>

</body>
</html>
